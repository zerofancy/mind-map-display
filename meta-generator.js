const fs = require('fs');
const path = require('path');

function traverseFolder(folderPath) {
    const childrenFolders = fs.readdirSync(folderPath).filter((item) => fs.statSync(path.join(folderPath, item)).isDirectory());
    const childrenNodes = childrenFolders.map((folder) => traverseFolder(path.join(folderPath, folder)))

    const noteFile = path.join(folderPath, "README.md")
    const nameFile = path.join(folderPath, ".name")

    let noteText = null
    let name = path.basename(folderPath)

    if (fs.existsSync(nameFile)) {
        try {
            name = fs.readFileSync(nameFile, 'utf8')
        } catch (e) {
        }
    }
    if (fs.existsSync(noteFile)) {
        try {
            noteText = fs.readFileSync(noteFile, 'utf8')
        } catch (e) {
            noteText = null
        }
    }
    return {
        "data": {
            "text": name,
            "note": noteText
        },
        "children": childrenNodes
    }
}

const folderPath = path.join(__dirname, 'meta');
const result = traverseFolder(folderPath)
console.log(JSON.stringify(result))

const content = "// This file is auto generated by meta-generator.js\nexport const metaData = " + JSON.stringify(result)

try {
    fs.writeFileSync(path.join(__dirname, 'meta-generated.js'), content);
    // file written successfully
} catch (err) {
  console.error(err);
}